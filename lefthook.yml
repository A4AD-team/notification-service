# Lefthook configuration for comment-service repository
# Git Flow enforcement with branch naming and commit message validation

# Pre-commit hook - runs before creating a commit
pre-commit:
  commands:
    # Run linter on staged files
    lint:
      run: npm run lint {staged_files}
      glob: '*.{ts,js,json}'
    # Run tests on staged files
    test:
      run: npm test -- --bail --passWithNoTests
      glob: '*.{ts,js}'
    # Check formatting
    format:
      run: npm run format:check {staged_files}
      glob: '*.{ts,js,json}'

# Commit message validation - enforces conventional commits
commit-msg:
  commands:
    conventional-commits:
      run: |
        COMMIT_MSG_FILE={1}
        COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")

        # Regex for conventional commits: type(scope)!: description
        PATTERN="^(feat|fix|docs|style|refactor|test|chore|perf|ci|build|revert)(\(.+\))?!?: .{1,50}"

        if ! [[ "$COMMIT_MSG" =~ $PATTERN ]]; then
          echo ""
          echo "‚ùå Invalid commit message format!"
          echo ""
          echo "Commit messages must follow conventional commits format:"
          echo "  <type>[optional scope]: <description>"
          echo ""
          echo "Types: feat, fix, docs, style, refactor, test, chore, perf, ci, build, revert"
          echo "Examples:"
          echo "  feat(auth): add JWT token validation"
          echo "  fix: resolve memory leak in rate limiter"
          echo "  docs(api): update authentication endpoints"
          echo ""
          echo "Max description length: 50 characters"
          exit 1
        fi

        # Check for subject line separation
        if [[ "$COMMIT_MSG" == *"\n"* ]]; then
          FIRST_LINE=$(echo "$COMMIT_MSG" | head -n1)
          if [[ ${#FIRST_LINE} -gt 72 ]]; then
            echo "‚ùå First line of commit message should not exceed 72 characters"
            echo "Current length: ${#FIRST_LINE}"
            exit 1
          fi
        fi

# Pre-push hook - validates branch naming and prevents pushes to protected branches
pre-push:
  commands:
    # Prevent pushes to protected branches
    protect-branches:
      run: |
        PROTECTED_BRANCHES="main|master|develop|release/*|hotfix/*"
        CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)

        # Check if current branch matches protected patterns
        if [[ "$CURRENT_BRANCH" =~ ^($PROTECTED_BRANCHES)$ ]]; then
          echo "‚ùå Push to protected branch '$CURRENT_BRANCH' is not allowed!"
          echo ""
          echo "Protected branches:"
          echo "  - main, master (production)"
          echo "  - develop (development integration)"
          echo "  - release/* (release preparation)"
          echo "  - hotfix/* (production hotfixes)"
          echo ""
          echo "Please create a pull request instead."
          exit 1
        fi

        # Check remote branch protection
        REMOTE_BRANCH=$(git rev-parse --abbrev-ref --symbolic-full-name @{u} 2>/dev/null || echo "")
        if [[ -n "$REMOTE_BRANCH" ]]; then
          REMOTE_BRANCH_NAME=$(echo "$REMOTE_BRANCH" | sed 's/[^/]*\///')
          if [[ "$REMOTE_BRANCH_NAME" =~ ^($PROTECTED_BRANCHES)$ ]]; then
            echo "‚ùå Push to protected remote branch '$REMOTE_BRANCH_NAME' is not allowed!"
            echo "Please create a pull request instead."
            exit 1
          fi
        fi

    # Validate branch naming conventions
    validate-branch-name:
      run: |
        CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)

        # Skip validation for main, master, and develop
        if [[ "$CURRENT_BRANCH" == "main" ]] || [[ "$CURRENT_BRANCH" == "master" ]] || [[ "$CURRENT_BRANCH" == "develop" ]]; then
          exit 0
        fi

        # Allowed branch patterns
        if ! [[ "$CURRENT_BRANCH" =~ ^(feature|bugfix|hotfix|release|test|docs|chore|refactor|perf)/.+$ ]]; then
          echo "‚ùå Invalid branch name: '$CURRENT_BRANCH'"
          echo ""
          echo "Branch names must follow Git Flow patterns:"
          echo "  feature/<description>     - New features"
          echo "  bugfix/<description>       - Bug fixes"
          echo "  hotfix/<description>       - Production hotfixes"
          echo "  release/<version>          - Release preparation"
          echo "  test/<description>         - Test branches"
          echo "  docs/<description>         - Documentation"
          echo "  chore/<description>        - Maintenance tasks"
          echo "  refactor/<description>     - Code refactoring"
          echo "  perf/<description>         - Performance improvements"
          echo ""
          echo "Examples:"
          echo "  feature/jwt-authentication"
          echo "  bugfix/memory-leak-fix"
          echo "  release/v1.2.0"
          echo ""
          echo "Please rename your branch:"
          echo "  git branch -m $CURRENT_BRANCH feature/your-feature-name"
          exit 1
        fi

    # Run full test suite before push
    full-test-suite:
      run: npm test
      glob: '*.{ts,js}'

# Post-checkout hook - optional for additional validation
post-checkout:
  commands:
    show-branch-info:
      run: |
        if [[ $3 == "1" ]]; then
          CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
          echo "üìç Checked out to branch: $CURRENT_BRANCH"
          
          if [[ "$CURRENT_BRANCH" == "main" ]] || [[ "$CURRENT_BRANCH" == "master" ]]; then
            echo "‚ö†Ô∏è  You're on the main production branch"
          elif [[ "$CURRENT_BRANCH" == "develop" ]]; then
            echo "üîß You're on the development integration branch"
          fi
        fi
